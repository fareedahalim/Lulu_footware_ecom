<%-include("../../views/partials/user/header")%>
<style>
    .review_box {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
    }

    h2, h4 {
        color: #333;
    }

    .btn-primary {
        background-color: #ff6f61;
        border-color: #ff6f61;
    }

    .btn-primary:hover {
        background-color: #ff4f41;
        border-color: #ff4f41;
    }

    .star-input {
        display: none;
    }

    .star-label {
        font-size: 30px;
        color: #ffd700;
        cursor: pointer;
    }

    .star-label:hover,
    .star-label:hover ~ .star-label {
        color: #ffcc00;
    }

    .star-input:checked ~ .star-label {
        color: #ffd700;
    }

    .product-image {
        transition: transform 0.5s ease;
        cursor: pointer;
        position: relative; /* Added for proper positioning */
    }

    .product-image:hover {
        transform: scale(1.2);
        z-index: 10;
    }

    #zoom-lens {
        display: none;
        position: absolute;
        border: 1px solid #000;
        border-radius: 50%;
        pointer-events: none;
        /* Ensure it stays above other elements */
        z-index: 1000;
    }
    .other-variants-title {
    font-size: 18px;
    margin-bottom: 15px;
    font-weight: bold;
    color: #333;
}

.other-variants-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.variant-card {
    width: 120px;
    text-align: center;
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    transition: transform 0.3s, box-shadow 0.3s;
    overflow: hidden;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.variant-card:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.variant-thumbnail {
    width: 100%;
    height: auto;
    border-bottom: 1px solid #ddd;
    padding: 5px;
}

.variant-info {
    padding: 10px;
    font-size: 14px;
    color: #555;
}

.variant-info span {
    font-weight: bold;
    color: #333;
}

</style>

<section class="banner-area organic-breadcrumb">
    <div class="container">
        <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
            <div class="col-first">
                <h1>Product Details Page</h1>
                <nav class="d-flex align-items-center">
                    <a href="">Home<span class="lnr lnr-arrow-right"></span></a>
                    <a href="">Shop<span class="lnr lnr-arrow-right"></span></a>
                    <a href="single-product.html">Product Details</a>
                </nav>
            </div>
        </div>
    </div>
</section>

<main>
    <div class="product_image_area">
        <div class="container">
            <div class="row s_product_inner">
                <div class="col-lg-6">
                    <div class="s_Product_carousel" style="position: relative;">
                        <div class="single-prd-item">
                            <img class="img-fluid product-image" src="<%=varient.images[0]%>" alt="Main Product Image">
                        </div>
                        <div class="single-prd-item">
                            <img class="img-fluid product-image" src="<%=varient.images[1]%>" alt="Additional Product Image 1">
                        </div>
                        <div class="single-prd-item">
                            <img class="img-fluid product-image" src="<%=varient.images[2]%>" alt="Additional Product Image 2">
                        </div>
                        
                    </div>
                    <div id="zoom-lens"></div>
                </div>
                <div class="col-lg-5 offset-lg-1">
                    <div class="s_product_text">
                        <h3><%=product.productName%></h3>
                        <% if (finalPrice < varient.price) { %>
                            <h1><del style="color: red;">&#8377;<%= varient.price %></del></h1>
                            <h2>&#8377;<%= finalPrice %></h2>
                        <% } else { %>
                            <h1>&#8377;<%= varient.price %></h1>
                        <% } %>
                        <div class="rating">
                            <% for (let i = 5; i >= 1; i--) { %>
                                <input type="radio" name="rating" value="<%= i %>" id="<%= i %>" class="star-input">
                                <label for="<%= i %>" class="star-label">☆</label>
                            <% } %>
                        </div>
                        <ul class="list">
                            <li><a class="active" href="#"><span>Category</span> : <%=product.category.categoryName%></a></li>
                            <li><a class="active" href="#"><span>Brand</span> : <%=product.brand.brandName%></a></li>
                            <li><a class="active" href="#"><span>Stock</span> : <%= varient.stock%></a></li>
                            <li><a class="active" href="#"><span>Size</span> : <%= varient.size%></a></li>
                            <li><span>Availability</span> : <%= varient.stock > 0 ? "In Stock" : "Out of Stock" %></li>
                        </ul>
                        <p><%=product.description%></p>
                        <% const hasOtherVariants = varientAll.some(vari => vari.productId.toString() === varient.productId.toString() && varient._id.toString() !== vari._id.toString()); %>

<% if (hasOtherVariants) { %>
    <h4 class="other-variants-title">Explore Other Variants</h4>
    <div class="other-variants-container">
        <% varientAll.forEach(vari => { %>
            <% if (vari.productId.toString() === varient.productId.toString() && varient._id.toString() !== vari._id.toString()) { %>
                <div class="variant-card">
                    <a href="/product-details/<%= vari._id %>">
                        <img class="variant-thumbnail" src="<%= vari.images[0] %>" alt="<%= vari.color %> - <%= vari.size %>">
                        <div class="variant-info">
                            <span><%= vari.color %> - <%= vari.size %></span>
                        </div>
                    </a>
                </div>
            <% } %>
        <% }) %>
    </div>
<% } %>

                        
                        <div class="card_area d-flex align-items-center">
                            <a class="primary-btn add-to-cart-btn" href="javascript:void(0)" data-stock="<%= varient.stock %>" data-id="<%= varient._id %>">Add to Cart</a>
                            <a class="icon_btn" href="/add-to-wishlist/<%=varient._id%>"><i class="lnr lnr lnr-heart"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<div class="container mt-5">
    <div class="row">
        <div class="col-lg-12">
            <h2 class="mb-4 text-center">Customer Reviews</h2>
            <% if (reviews.length > 0) { %>
                <div class="review_list mb-5">
                    <% reviews.forEach(review => { %>
                        <div class="review_item">
                            <h5><%= review.username %> <small>(<%= review.rating %> stars)</small></h5>
                            <p><%= review.comment %></p>
                            <p><small><%= new Date(review.createdAt).toLocaleDateString() %></small></p>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <p class="text-muted">No reviews yet. Be the first to review this product!</p>
            <% } %>
            <div class="review_box p-4 rounded shadow-sm">
                <h4 class="mb-4 text-center">Add a Review</h4>
                <form class="row contact_form" action="/product-details/<%= varient._id %>/submit-review" method="post" id="reviewForm">
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <input type="text" class="form-control form-control-lg" name="username" placeholder="Your Full Name" required>
                        </div>
                    </div>
                    <div class="col-md-12 mb-3">
                        <div class="form-group">
                            <textarea class="form-control form-control-lg" name="comment" rows="4" placeholder="Your Review" required></textarea>
                        </div>
                    </div>
                    <div class="col-md-12 mb-4">
                        <div class="form-group">
                            <label for="rating">Rating:</label>
                            <div class="rating">
                                <% for (let i = 5; i >= 1; i--) { %>
                                    <input type="radio" name="rating" value="<%= i %>" id="rating-<%= i %>" class="star-input" required>
                                    <label for="rating-<%= i %>" class="star-label">☆</label>
                                <% } %>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 text-center">
                        <button type="submit" class="btn btn-primary btn-lg">Submit Now</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<%-include("../../views/partials/user/footer")%>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', function () {
            const stock = this.getAttribute('data-stock');
            const productId = this.getAttribute('data-id');

            // Check if product is out of stock
            if (stock == 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'The product is out of stock!',
                    confirmButtonText: 'Okay'
                });
            } else {
                // Redirect to add to cart if in stock
                window.location.href = `/add-to-cart/${productId}`;
            }
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        const images = document.querySelectorAll('.product-image');
        const lens = document.getElementById('zoom-lens');

        images.forEach(image => {
            image.addEventListener('mouseover', function() {
                lens.style.display = 'block';
                lens.style.width = '100px'; // Adjust size as needed
                lens.style.height = '100px'; // Adjust size as needed
                lens.style.backgroundImage = `url(${this.src})`;
                lens.style.backgroundSize = `${this.offsetWidth * 2}px ${this.offsetHeight * 2}px`;
            });

            image.addEventListener('mousemove', function(e) {
                const rect = this.getBoundingClientRect();
                let x = e.clientX - rect.left - lens.offsetWidth / 2;
                let y = e.clientY - rect.top - lens.offsetHeight / 2;

                if (x < 0) x = 0;
                if (y < 0) y = 0;
                if (x > rect.width - lens.offsetWidth) x = rect.width - lens.offsetWidth;
                if (y > rect.height - lens.offsetHeight) y = rect.height - lens.offsetHeight;

                lens.style.left = `${x}px`;
                lens.style.top = `${y}px`;
                lens.style.backgroundPosition = `-${x * 2}px -${y * 2}px`;
            });

            image.addEventListener('mouseout', function() {
                lens.style.display = 'none';
            });
        });
    });
</script>
