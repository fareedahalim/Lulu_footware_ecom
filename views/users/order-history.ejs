<%- include("../../views/partials/user/header") %>
<style>
  .table-responsive {
    margin-top: 20px;
  }
  
  .blue-button {
    background-color: #FF8C00;
    color: white;
    border: none;
    padding: 10px 20px;
    text-align: center;
    text-decoration: none;
    font-size: 16px;
    cursor: pointer;
    border-radius: 4px;
}

    .blue-button a {
        color: inherit;
        text-decoration: none;
    }


    .table {
    border-collapse: separate;
    border-spacing: 0;
    width: 100%;
    background-color: #ffffff;
    box-shadow: 0 0 20px #a8af60;
    /* Remove border-radius to avoid curved corners */
    border-radius: 0;
}

  .thead-dark th {
    background-color: #4DB6AC;
    color: #ffffff;
    padding: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    /* Remove rounded corners */
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}



  .table-hover tbody tr:hover {
    background-color: #f8f9fa;
    cursor: pointer;
  }

  .table-bordered th,
  .table-bordered td {
    border: 1px solid #dee2e6;
    padding: 15px;
    vertical-align: middle;
  }

  .text-center {
    text-align: center;
  }

  .btn-primary {
    background-color: #FF8C00;
    border-color: #007bff;
    color: #ffffff;
    padding: 8px 16px;
    border-radius: 5px;
  }

  .btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: #ffffff;
    padding: 8px 16px;
    border-radius: 5px;
  }

  .btn-dark {
    background-color: #343a40;
    border-color: #343a40;
    color: #ffffff;
    padding: 8px 16px;
    border-radius: 5px;
  }

  .btn-primary:hover,
  .btn-danger:hover,
  .btn-dark:hover {
    opacity: 0.9;
  }

  .form-control {
    width: 80%;
    margin: 10px auto;
    padding: 8px 10px;
    border-radius: 5px;
    border: 1px solid #ced4da;
  }

  /* Add responsiveness */
  @media (max-width: 768px) {
    .table-responsive {
      overflow-x: auto;
    }
  }

  /* Pagination styling */
  .pagination {
    display: inline-block;
    list-style: none;
    padding: 0;
    margin-top: 20px;
    display: flex;
    justify-content: center;
    /* Center the pagination */
  }

  .pagination .page-item {
    display: inline-block;
    margin: 0 5px;
  }

  .pagination .page-link {
    background-color: #ffffff;
    color: #007bff;
    border: 1px solid #dee2e6;
    padding: 10px 15px;
    border-radius: 5px;
    text-decoration: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .pagination .page-link:hover {
    background-color: #007bff;
    color: #ffffff;
  }

  .pagination .active .page-link {
    background-color: #007bff;
    color: #ffffff;
    border-color: #007bff;
  }

  .pagination .page-link span {
    font-weight: bold;
  }

  @media (max-width: 768px) {
    .pagination {
      text-align: center;
    }
  }
</style>
<section class="banner-area organic-breadcrumb">
  <div class="container">
      <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
          <div class="col-first">
              <h1>Order</h1>
              <nav class="d-flex align-items-center">
                  <a href="/">Home<span class="lnr lnr-arrow-right"></span></a>
                  <a href="/order-history">Order</a>
              </nav>
          </div>
      </div>
  </div>
</section>
<div class="page-content">
  <div class="cart">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <form method="GET" action="/order-history" class="form-inline mb-4">
            <input type="text" name="search" class="form-control" placeholder="search orders" value="<%=searchQuery%>">
            <button type="submit" class="btn btn-primary ml-2">Search</button>
          </form>
          <% if (error.length > 0) { %> <!-- Check if there's an error -->
    <div class="alert alert-danger">
        <%= error[0] %> <!-- Output the first error message -->
    </div>
<% } %>
          <div class="table-responsive">
           
            <table class="table table-bordered table-hover">
              <thead class="thead-dark">
                <tr>
                 
                  <th class="text-center">Order Date</th>
                  <th class="text-center">Shipped Address</th>
                  <!-- <th class="text-center">Payment Method</th> -->
                  <th class="text-center">Grand Total</th>
                  <th class="text-center">Order Status</th>
                  <!-- <th class="text-center">Payment Status</th> -->
                  <th class="text-center">Product Details</th>
                  <th class="text-center">Action</th>
                  <th class="text-center">Invoice</th>
                </tr>
              </thead>
              <tbody>
                <% if (orderData.length === 0) { %>
                  <tr>
                    <td colspan="10" class="text-center">No orders found.</td>
                  </tr>
                <% } else { %>
                  <% orderData.forEach(order => { %>
                    <tr>
                      <td class="text-center"><%= order.orderDate.toLocaleDateString() %></td>
                      <td class="text-center">
                        <%= order.address[0].username %>, <%= order.address[0].city %>, 
                        <%= order.address[0].mobile %>, <%= order.address[0].pincode %>, <%= order.address[0].state %>
                      </td>
                      <td class="text-center">Rs.<%= order.totalAmount %></td>
                      
                      <% if (order.paymentStatus == false) { %>
                        <td class="text-center">Failed</td>
                      <% } else { %>
                        <td class="text-center"><%= order.status %></td>
                      <% } %>
                      
                      <td class="text-center">
                        <a href="/view-order/<%= order._id %>" class="btn btn-dark">View Products</a>
                      </td>
                      
                      <td class="text-center">
                        <% if (order.paymentStatus === false && order.status === 'Pending') { %>
                          <button class="btn btn-warning" onclick="retryPayment('<%= order._id %>')">Retry</button>
                        <% } else if (order.status === 'Delivered') { %>
                          <a href="/return-order/<%= order._id %>/returned">
                            <button class="btn btn-danger">Return Order</button>
                          </a>
                        <% } else if (order.status === 'Returned') { %> <!-- Corrected condition for Returned -->
                          <p>You returned the order</p>
                        <% } else if (order.status === 'Cancelled') { %>
                          <p>Order Cancelled</p>
                        <% } else { %>
                          <a href="/cancel-order/<%= order._id %>/cancelled">
                            <button class="btn btn-danger">Cancel Order</button>
                          </a>
                        <% } %>
              
                        <% if (order.status === 'Delivered' || order.status === 'Returned') { %>
                          <td class="text-center">
                            <a href="/order/<%= order._id %>/invoice">
                              <button class="btn btn-primary">Download Invoice</button>
                            </a>
                          </td>
                        <% } else { %>
                          <td class="text-center">-</td>
                        <% } %>
                      </td>
                    </tr>
                  <% }) %>
                <% } %>
              </tbody>
              
              
            
              
            </table>
            <br>
            <a href="/shop"> <button class="blue-button"> Go To Shopping page</button></a>
            <a href="/profile"> <button class="blue-button"> Go To PROFILE</button></a>
          </div><!-- End .table-responsive -->
          <nav aria-label="Page navigation example">
            <ul class="pagination de-flex justify-content-center mt-4">
              <% if (currentPage> 1) { %>
                <li class="page-item">
                  <a class="page-link" href="/order-history?page=<%= currentPage - 1 %>&search=<%= searchQuery %>"
                    aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                <% } %>
                  <% for (let i=1; i <=totalPages; i++) { %>
                    <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                      <a class="page-link" href="/order-history?page=<%= i %>&search=<%= searchQuery %>">
                        <%= i %>
                      </a>
                    </li>
                    <% } %>
                      <% if (currentPage < totalPages) { %>
                        <li class="page-item">
                          <a class="page-link"
                            href="/order-history?page=<%= currentPage + 1 %>&search=<%= searchQuery %>"
                            aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                          </a>
                        </li>
                        <% } %>

            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet"/>
<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
  function retryPayment(orderId) {
      window.location.href = `/retry-payment/${orderId}`;
  }


  <% if (error.length > 0) { %>
            toastr.error('<%= error[0] %>', 'Error'); // Use the first error message
  <% } %>
    </script>




  
<%- include("../../views/partials/user/footer") %>