<%- include("../../views/partials/user/header") %>
<!-- noUiSlider CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.css" rel="stylesheet" />

<!-- noUiSlider JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>

	<style>
		.out-of-stock {
			color: red;
			font-weight: bold;
		}


		.single-product img {
			display: inline;
			max-width: 100%;
			max-height: 250px;
			/* Adjust this value to your preference */
			object-fit: cover;
			width: auto;
			height: auto;
		}
		.price-slider {
    margin: 20px 0;
}

.value-wrapper {
    margin-top: 10px;
    font-size: 16px;
}

.price-slider .noUi-connect {
    background-color: #5a88ca; /* Customize the connect color */
}

.price-slider .noUi-handle {
    background-color: #5a88ca; /* Customize the handle color */
}

	</style>
	<!-- Start Banner Area -->
	<section class="banner-area organic-breadcrumb">
		<div class="container">
			<div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
				<div class="col-first">
					<h1>Shop Category page</h1>
					<nav class="d-flex align-items-center">
						<a href="index.html">Home<span class="lnr lnr-arrow-right"></span></a>
						<a href="#">Shop<span class="lnr lnr-arrow-right"></span></a>
						<a href="category.html">Fashon Category</a>
					</nav>
				</div>
			</div>
		</div>
	</section>
	<!-- End Banner Area -->
	<div class="container">
		<div class="row">

			<div class="col-xl-3 col-lg-4 col-md-5">
				<div class="sidebar-categories">
					<div class="head">Browse Categories</div>
					<ul class="main-categories">
						<% occasionData.forEach(occasion=> { %>
							<li class="main-nav-list">
								<a href="/shop?category=<%= occasion._id %>">

									<%= occasion.categoryName %>
								</a>
							</li>
							<% }) %>
					</ul>
				</div>
				<div class="sidebar-filter mt-50">
					<div class="top-filter-head">Product Filters</div>
					<div class="common-filter">
						<div class="head">Brands</div>
						<form action="#">
							<ul class="main-categories">
								<% brandData.forEach(brand=> { %>
									<li class="main-nav-list">
										<a href="/shop?brand=<%= brand._id %>">
											<%= brand.brandName %>
										</a>
									</li>
									<% }) %>
							</ul>
						</form>
					</div>

					<div class="head">Color</div>
					<form action="#" >
						<ul class="main-categories">
							<% uniqueColors.forEach(color=> { %>
								<li class="main-nav-list">
									<a href="/shop?color=<%= color %>">
										<%= color %>
									</a>
								</li>
								<% }) %>
						</ul>
					</form>
					
				</div>
			</div>
			<div class="col-xl-9 col-lg-8 col-md-7">
				<!-- Start Filter Bar -->

				<div class="filter-bar d-flex flex-wrap align-items-center">
					<div class="sorting">
						<input type="text" id="searchInput" placeholder="Search product name..."
							oninput="filterProducts()">
					</div>
					<div class="sorting">
						<select id="sortDropdown" onchange="sortProducts()">
							<option value="">Sort By</option>
							<option value="name_asc">Name (A-Z)</option>
							<option value="name_desc">Name (Z-A)</option>
							<option value="price_asc">Price (Low to High)</option>
							<option value="price_desc">Price (High to Low)</option>
						</select>



					</div>
					
				</div>
				
				<div class="single-product-slider" id="productsContainer">
					<div class="container">
						<div class="row justify-content-center">
							<div class="col-lg-6 text-center">
								<div class="section-title">
									<h1>Latest Products</h1>
									
								</div>
							</div>
						</div>
						<div class="sorting-product">
							<div class="row">
								<% products.forEach(product=> { %>
									<% product.variants.forEach(variant=> { %>
										<div class="col-lg-3 col-md-6 mb-4  single-product-wrapper">
											<!-- Adjust grid size based on screen size -->
											<div class="single-product">
												<a href="/product-details/<%= variant._id %>" class="social-info">
													<img class="img-fluid" src="<%= variant.images[0] %>" alt="">
												</a>
												<div class="product-details">
													<h6 class="product-name">
														<%= product.productName %>
													</h6>

													<% if (variant.stock===0) { %>
														<p class="out-of-stock">Out of Stock</p>
														<% } else { %>
															<div class="price">
																<% if (variant.finalPrice < variant.price) { %>
																	<!-- Show original price with strikethrough when discount is applied -->
																	<h6><del style="color: red;">&#8377;<%= variant.price %></del></h6>
																	<h6>&#8377;<%= variant.finalPrice %></h6>
																<% } else { %>
																	<!-- Show only the original price when no discount is applied -->
																	<h6>&#8377;<%= variant.price %></h6>
																<% } %>
															</div>
															
															<% } %>

																<div class="prd-bottom">
																	<a href="javascript:void(0)" class="social-info add-to-cart-btn" data-stock="<%= variant.stock %>" data-id="<%= variant._id %>">
																		<span class="ti-bag"></span>
																		<p class="hover-text">add to bag</p>
																	</a>
																	<a href="/add-to-wishlist/<%=variant._id%>"
																		class="social-info">
																		<span class="lnr lnr-heart"></span>
																		<p class="hover-text">Wishlist</p>
																	</a>
																	
																</div>
												</div>
											</div>
										</div>
										<% }) %>
											<% }) %>
							</div> <!-- End row -->

						</div>

					</div>
					<div class="pagination">
			<% if (currentPage > 1) { %>
				<a href="?page=<%= currentPage - 1 %>&search=<%= searchInput || '' %>" class="prev-arrow">
					<i class="fa fa-long-arrow-left" aria-hidden="true"></i>
				</a>
			<% } %>
		
			<% for (let i = 1; i <= totalPages; i++) { %>
				<a href="?page=<%= i %>&search=<%= searchInput || '' %>" class="<%= currentPage === i ? 'active' : '' %>">
					<%= i %>
				</a>
			<% } %>
		
			<% if (currentPage < totalPages) { %>
				<a href="?page=<%= currentPage + 1 %>&search=<%= searchInput || '' %>" class="next-arrow">
					<i class="fa fa-long-arrow-right" aria-hidden="true"></i>
				</a>
			<% } %>
		</div>
				</div>



			</div>
		</div>
		
		
	</div>



	
<%- include("../../views/partials/user/footer") %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
		<script>
 document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', function () {
            const stock = this.getAttribute('data-stock');
            const productId = this.getAttribute('data-id');

            // Check if product is out of stock
            if (stock == 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'The product is out of stock!',
                    confirmButtonText: 'Okay'
                });
            } else {
                // Redirect to add to cart if in stock
                window.location.href = `/add-to-cart/${productId}`;
            }
        });
    });
			


			function filterProducts() {
    let searchInput = document.getElementById("searchInput").value.toLowerCase();
    let products = document.querySelectorAll(".single-product-wrapper");

    // Reset the display for pagination
    let totalVisibleProducts = 0;

    products.forEach(product => {
        let productName = product.querySelector(".product-name").innerText.toLowerCase();
        if (productName.includes(searchInput)) {
            product.style.display = "block"; // Show the product if it matches
            totalVisibleProducts++;
        } else {
            product.style.display = "none"; // Hide the product if it doesn't match
        }
    });

    // Update pagination based on visible products
    updatePagination(totalVisibleProducts);
}

function updatePagination(totalVisibleProducts) {
    const totalPages = Math.ceil(totalVisibleProducts / itemsPerPage); // Adjust itemsPerPage based on your setting
   
}



			function sortProducts() {
    console.log("Entering sorting");
    let sortOption = document.getElementById("sortDropdown").value;
    console.log("sortOption =", sortOption);
    let productsContainer = document.querySelector(".sorting-product .row"); // Select the row that contains products
    console.log("productsContainer =", productsContainer);
    
    if (!productsContainer) {
        console.error("Products container not found!");
        return; // Exit if the container is not found
    }

    let products = Array.from(productsContainer.querySelectorAll(".col-lg-3")); // Select all parent columns
    console.log("products =", products);

    // Check if products are found
    if (products.length === 0) {
        console.error("No products found!");
        return; // Exit if no products are found
    }

    products.sort((a, b) => {
        // Get product names
        let nameA = a.querySelector('.product-name') ? a.querySelector('.product-name').innerText.toUpperCase() : '';
        let nameB = b.querySelector('.product-name') ? b.querySelector('.product-name').innerText.toUpperCase() : '';
        console.log("nameA =", nameA);
        console.log("nameB =", nameB);

        // Get product prices
        let priceA = a.querySelector('.price h6') ? parseFloat(a.querySelector('.price h6').innerText.replace('₹', '').replace(',', '')) || 0 : 0;
        let priceB = b.querySelector('.price h6') ? parseFloat(b.querySelector('.price h6').innerText.replace('₹', '').replace(',', '')) || 0 : 0;
        console.log("priceA =", priceA);
        console.log("priceB =", priceB);

        switch (sortOption) {
            case 'name_asc':
                return nameA.localeCompare(nameB);
            case 'name_desc':
                return nameB.localeCompare(nameA);
            case 'price_asc':
                return priceA - priceB;
            case 'price_desc':
                return priceB - priceA;
            default:
                return 0;
        }
    });

    console.log("Sorting by:", sortOption);

    // Clear the container and re-append sorted products
    productsContainer.innerHTML = ""; // Clear the existing products
    products.forEach(product => {
        productsContainer.appendChild(product); // Re-append the sorted parent columns
    });
    console.log("Products after sorting:", products);
}


			document.addEventListener('DOMContentLoaded', function() {
    // Initialize the price slider
    var priceSlider = document.getElementById('price-slider');

    noUiSlider.create(priceSlider, {
        start: [0, 1000], // Initial values for the slider
        connect: true,
        range: {
            'min': 0,
            'max': 1000
        },
        step: 1, // Step size
        tooltips: [true, true], // Show tooltips for values
        format: {
            to: function (value) {
                return parseInt(value);
            },
            from: function (value) {
                return parseInt(value);
            }
        }
    });

    // Update display and hidden input values when the slider is moved
    priceSlider.noUiSlider.on('update', function (values) {
        document.getElementById('minPriceDisplay').innerHTML = values[0];
        document.getElementById('maxPriceDisplay').innerHTML = values[1];

        // Update hidden inputs with the slider values
        document.getElementById('minPrice').value = values[0];
        document.getElementById('maxPrice').value = values[1];
    });
});

		</script>